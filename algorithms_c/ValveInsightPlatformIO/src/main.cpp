#include <stdio.h>

#include <switchingDetectionFixed.h>
#include <switchingDurationIntegralThreshold.h>


int16_t current_ADC[] = { 14635, 21495, 22855, 23315, 23290, 23035, 22710, 22430, 22060, 21675, 21355, 20920, 20585, 20300, 19995, 19725, 19365, 19125, 18865, 18625, 18455, 18175, 18010, 17765, 17520, 17420, 17150, 16995, 16855, 16675, 16485, 16370, 16265, 16239, 16110, 16045, 15930, 15780, 15750, 15675, 15675, 15610, 15560, 15610, 15610, 15675, 15675, 15675, 15740, 15780, 15780, 15945, 15970, 16075, 16149, 16239, 16405, 16495, 16715, 16920, 17035, 17280, 17430, 17650, 17880, 18110, 18365, 18660, 18865, 19215, 19445, 19765, 20110, 20300, 20685, 20890, 21175, 21535, 21700, 22060, 22240, 22455, 22775, 22865, 23110, 23315, 23390, 23595, 23700, 23840, 24030, 24070, 24200, 24250, 24290, 24415, 24440, 24530, 24480, 24480, 24545, 24560, 24560, 24595, 24480, 24585, 24530, 24495, 24585, 24530, 24545, 24480, 24415, 24480, 24440, 24440, 24440, 24380, 24380, 24315, 24355, 24415, 24380, 24405, 24380, 24315, 24405, 24355, 24405, 24355, 24315, 24380, 24355, 24405, 24415, 24355, 24440, 24405, 24380, 24440, 24440, 24470, 24470, 24415, 24480, 24470, 24480, 24530, 24470, 24545, 24530, 24530, 24595, 24570, 24595, 24595, 24570, 24635, 24595, 24635, 24635, 24595, 24650, 24650, 24710, 24765, 24710, 24765, 24765, 24710, 24800, 24735, 24790, 24790, 24765, 24790, 24790, 24765, 24790, 24790, 24825, 24800, 24765, 24855, 24800, 24855, 24855, 24800, 24855, 24815, 24840, 24905, 24790, 24855, 24840, 24855, 24915, 24890, 24890, 24905, 24855, 24915, 24905, 24915, 24915, 24855, 24915, 24915, 24905, 24940, 24915, 24970, 24915, 24915, 24940, 24940, 24940, 24940, 24915, 24915, 24915, 24940, 24995, 24915, 24970, 24970, 24940, 24995, 24970, 24995, 24970, 24940, 24970, 24970, 25030, 25030, 24915, 24970, 24940, 24940, 25030, 24970, 24995, 25060, 24970, 25030, 24970, 24995, 24995, 24915, 24995, 24970, 24995, 25030, 24970, 25030, 24970, 24940, 24995, 24970, 25030, 24995, 24970, 25030, 24995, 24995, 25070, 25030, 25070, 25030, 24995, 25070, 25030, 25095, 25060, 25030, 25030, 24970, 25060, 25095, 25030, 25060, 25030, 25030, 25070, 25030, 25095, 25070, 25030, 25095, 25060, 25095, 25070, 24995, 25070, 25060, 25030, 25095, 24995, 25070, 25070, 25060, 25120, 25030, 25095, 25095, 25030, 25070, 25030, 25070, 25120, 25030, 25120, 25070, 25095, 25135, 25095, 25095, 25095, 25060, 25095, 25095, 25120, 25120, 25030, 25120, 25095, 25120, 25135, 25120, 25120, 25095, 25070, 25135, 25120, 25120, 25120, 25060, 25070, 25070, 25095, 25135, 25095, 25120, 25095, 25120, 25160, 25120, 25160, 25135, 25070, 25120, 25095, 25120, 25120, 25120, 25160, 25135, 25120, 25210, 25135, 25210, 25135, 25120, 25160, 25135, 25185, 25185, 25120, 25185, 25135, 25160, 25210, 25160, 25185, 25160, 25120, 25225, 25120, 25185, 25175, 25120, 25225, 25135, 25160, 25225, 25160, 25225, 25185, 25120, 25235, 25160, 25185, 25185, 25135, 25210, 25160, 25210, 25185, 25135, 25185, 25160, 25185, 25225, 25210, 25235, 25210, 25160, 25250, 25185, 25225, 25225, 25120, 25225, 25160, 25175, 25250, 25185, 25185, 25185, 25160, 25250, 25210, 25225, 25225, 25160, 25225, 25185, 25210, 25250, 25160, 25225, 25185, 25160, 25250, 25160, 25210, 25185, 25120, 25160, 25135, 25160, 25185, 25120, 25225, 25160, 25160, 25225, 25175, 25225, 25185, 25120, 25210, 25160, 25185, 25185, 25120, 25185, 25135, 25135, 25250, 25185, 25225, 25185, 25160, 25225, 25185, 25235, 25185, 25120, 25160, 25185, 25160, 25210, 25120, 25185, 25160, 25160, 25185, 25160, 25250, 25160, 25160, 25160, 25160, 25185, 25225, 25135, 25225, 25160, 25160, 25225, 25210, 25250, 25185, 25135, 25250, 25175, 25210, 25165 };
static const double SWITCHING_THRESHOLD = 0.8;


int main(int argc, char **argv) 
{ 
  printf("Simulated measurement started.\n");

  // Reset before new measurement
  switchingDetectionFixed_Reset();
  switchingDurationIntegralThreshold_Reset();

  // Simulate data acquisition
  size_t length = sizeof(current_ADC) / sizeof(current_ADC[0]);
  for (size_t i = 0; i < length; ++i) {
      switchingDetectionFixed_StoreADC(current_ADC[i]);
      switchingDurationIntegralThreshold_StoreADC(current_ADC[i]);
  }

  // Calculate switching integral
  double integral = switchingDetectionFixed_Calculate(0.05);
  // Calculate switching duration
  double duration = switchingDurationIntegralThreshold_Calculate(0.05, SWITCHING_THRESHOLD);

  // switching successful if integral exceeds threshold
  if (integral > SWITCHING_THRESHOLD) {
      printf("Valve switching successful. (Integral value: %f)\n", integral);
      printf("Estimated switching duration: %f milliseconds\n", duration);
  }

  return 0; 
} 
